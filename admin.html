<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grease Admin Panel</title>

<style>
    body {
        background: #f4f4f9;
        font-family: Arial Black, sans-serif;
        margin: 0;
        padding: 20px;
        color: #2a2a2a;
    }

    h1 {
        color: #da291c;
        text-align: center;
        margin-bottom: 30px;
    }

    .admin-wrapper {
        display: flex;
        gap: 25px;
        max-width: 1300px;
        margin: auto;
    }

    .panel {
        flex: 1;
        background: white;
        padding: 20px;
        border-radius: 15px;
        border: 4px solid #2a2a2a;
    }

    h2 {
        margin-top: 0;
        color: #da291c;
    }

    label {
        display: block;
        margin-top: 10px;
        font-size: 0.9rem;
    }

    input, textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 8px;
        border: 2px solid #2a2a2a;
        font-family: inherit;
        font-size: 0.95rem;
        box-sizing: border-box;
    }

    textarea {
        min-height: 70px;
        resize: vertical;
    }

    button {
        margin-top: 15px;
        padding: 8px 14px;
        background: #da291c;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
    }

    button:hover {
        background: #b71f15;
    }

    .list-item {
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
    }

    .list-title {
        font-weight: bold;
    }

    .list-meta {
        font-size: 0.85rem;
        color: #555;
    }

    .row-buttons button {
        margin-right: 5px;
        padding: 5px 10px;
        font-size: 0.8rem;
    }

    .status {
        margin-top: 10px;
        font-size: 0.9rem;
    }
</style>
</head>

<body>

<h1>Grease Admin Panel</h1>

<div class="admin-wrapper">

    <!-- REHEARSAL SCHEDULE PANEL -->
    <div class="panel">
        <h2>Rehearsal Schedule</h2>

        <label>Title</label>
        <input id="sch_title">

        <label>Date (dd/mm/yyyy)</label>
        <input id="sch_date">

        <label>Time</label>
        <input id="sch_time">

        <label>Who is needed</label>
        <input id="sch_who">

        <label>Extra info</label>
        <textarea id="sch_extra"></textarea>

        <button id="sch_saveBtn">Save</button>
        <button id="sch_clearBtn" style="background:#555;">Clear</button>

        <div class="status" id="sch_status"></div>

        <h3>Existing Schedule</h3>
        <div id="scheduleList">Loading...</div>
    </div>

    <!-- ANNOUNCEMENTS PANEL -->
    <div class="panel">
        <h2>Announcements</h2>

        <label>Title</label>
        <input id="ann_title">

        <label>Message</label>
        <textarea id="ann_message"></textarea>

        <label>Sent By</label> 
        <input id="ann_sentby">

        <button id="ann_saveBtn">Save</button>
        <button id="ann_clearBtn" style="background:#555;">Clear</button>

        <div class="status" id="ann_status"></div>

        <h3>Existing Announcements</h3>
        <div id="annList">Loading...</div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
    getFirestore, collection, addDoc, updateDoc, deleteDoc,
    doc, onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAecPf2aXR0j1buuDmz9MVrS8aYINs1eCU",
    authDomain: "grease-practicebase.firebaseapp.com",
    projectId: "grease-practicebase",
    storageBucket: "grease-practicebase.firebasestorage.app",
    messagingSenderId: "696484090016",
    appId: "1:696484090016:web:4d7bfe336d842ed946b9c5",
    measurementId: "G-4C78RPXQ99"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "grease-admin@duckers.dev";

onAuthStateChanged(auth, user => {
    if (!user || user.email !== ADMIN_EMAIL) {
        window.location.href = "index.html";
    }
});

/* -------------------------
   UTIL: Build sort timestamp
-------------------------- */
function buildSortTimestamp(dateText) {
    const [dd, mm, yyyy] = dateText.split("/").map(Number);
    return new Date(yyyy, mm - 1, dd).getTime();
}

/* -------------------------
   REHEARSAL SCHEDULE CRUD
-------------------------- */
let editingScheduleId = null;

const sch_title = document.getElementById("sch_title");
const sch_date = document.getElementById("sch_date");
const sch_time = document.getElementById("sch_time");
const sch_who = document.getElementById("sch_who");
const sch_extra = document.getElementById("sch_extra");
const sch_status = document.getElementById("sch_status");
const scheduleList = document.getElementById("scheduleList");

document.getElementById("sch_clearBtn").onclick = () => {
    editingScheduleId = null;
    sch_title.value = "";
    sch_date.value = "";
    sch_time.value = "";
    sch_who.value = "";
    sch_extra.value = "";
    sch_status.textContent = "Ready.";
};

document.getElementById("sch_saveBtn").onclick = async () => {
    const title = sch_title.value.trim();
    const date = sch_date.value.trim();
    const time = sch_time.value.trim();
    const who = sch_who.value.trim();
    const extra = sch_extra.value.trim();

    if (!title || !date) {
        sch_status.textContent = "Title and date required.";
        sch_status.style.color = "red";
        return;
    }

    const sortTimestamp = buildSortTimestamp(date);

    try {
        if (editingScheduleId) {
            await updateDoc(doc(db, "announcements", editingScheduleId), {
                title, date, time, who, extra, sortTimestamp
            });
            sch_status.textContent = "Updated.";
        } else {
            await addDoc(collection(db, "announcements"), {
                title, date, time, who, extra, sortTimestamp
            });
            sch_status.textContent = "Created. Notifications Sent!";
        }
        sch_status.style.color = "green";
    } catch {
        sch_status.textContent = "Error saving.";
        sch_status.style.color = "red";
    }
};

const scheduleQuery = query(
    collection(db, "announcements"),
    orderBy("sortTimestamp", "asc")
);

onSnapshot(scheduleQuery, snapshot => {
    scheduleList.innerHTML = "";

    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const row = document.createElement("div");
        row.className = "list-item";

        row.innerHTML = `
            <div class="list-title">${data.title}</div>
            <div class="list-meta">${data.date} â€” ${data.time}<br>${data.who}</div>
            <div class="row-buttons">
                <button class="edit" data-id="${docSnap.id}">Edit</button>
                <button class="del" data-id="${docSnap.id}" style="background:#555;">Delete</button>
            </div>
        `;

        scheduleList.appendChild(row);
    });

    scheduleList.querySelectorAll(".edit").forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.id;
            const docSnap = snapshot.docs.find(d => d.id === id);
            const data = docSnap.data();

            editingScheduleId = id;
            sch_title.value = data.title;
            sch_date.value = data.date;
            sch_time.value = data.time;
            sch_who.value = data.who;
            sch_extra.value = data.extra || "";
            sch_status.textContent = "Editing...";
        };
    });

    scheduleList.querySelectorAll(".del").forEach(btn => {
        btn.onclick = async () => {
            if (!confirm("Delete this rehearsal?")) return;
            await deleteDoc(doc(db, "announcements", btn.dataset.id));
        };
    });
});

/* -------------------------
   ANNOUNCEMENTS CRUD
-------------------------- */
let editingAnnId = null;

const ann_title = document.getElementById("ann_title");
const ann_message = document.getElementById("ann_message");
const ann_status = document.getElementById("ann_status");
const annList = document.getElementById("annList");

document.getElementById("ann_clearBtn").onclick = () => {
    editingAnnId = null;
    ann_title.value = "";
    ann_message.value = "";
    ann_status.textContent = "Ready.";
};

document.getElementById("ann_saveBtn").onclick = async () => {
    const title = ann_title.value.trim();
    const message = ann_message.value.trim();

    if (!title || !message) {
        ann_status.textContent = "Title and message required.";
        ann_status.style.color = "red";
        return;
    }

   try {
    const sentBy = document.getElementById("ann_sentby").value.trim();

    if (editingAnnId) {
        await updateDoc(doc(db, "siteAnnouncements", editingAnnId), {
            title,
            message,
            sentBy
        });
        ann_status.textContent = "Updated.";
    } else {
        await addDoc(collection(db, "siteAnnouncements"), {
            title,
            message,
            createdAt: Date.now(),
            sentBy
        });
        ann_status.textContent = "Created.";
    }

    ann_status.style.color = "green";

} catch (err) {
    ann_status.textContent = "Error saving.";
    ann_status.style.color = "red";
}


const annQuery = query(
    collection(db, "siteAnnouncements"),
    orderBy("createdAt", "desc")
);

onSnapshot(annQuery, snapshot => {
    annList.innerHTML = "";

    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const row = document.createElement("div");
        row.className = "list-item";

        row.innerHTML = `
            <div class="list-title">${data.title}</div>
            <div class="list-meta">${data.message}<br><em>Sent by: ${data.sentBy}</em></div>
            <div class="row-buttons">
                <button class="editAnn" data-id="${docSnap.id}">Edit</button>
                <button class="delAnn" data-id="${docSnap.id}" style="background:#555;">Delete</button>
            </div>
        `;

        annList.appendChild(row);
    });

    annList.querySelectorAll(".editAnn").forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.id;
            const docSnap = snapshot.docs.find(d => d.id === id);
            const data = docSnap.data();

            editingAnnId = id;
            ann_title.value = data.title;
            ann_message.value = data.message;
            ann_status.textContent = "Editing...";
        };
    });

    annList.querySelectorAll(".delAnn").forEach(btn => {
        btn.onclick = async () => {
            if (!confirm("Delete this announcement?")) return;
            await deleteDoc(doc(db, "siteAnnouncements", btn.dataset.id));
        };
    });
});

</script>

</body>
</html>
